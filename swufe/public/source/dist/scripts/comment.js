define(["jquery"],function(){function e(){return JLib.config.userId<0?(alert("Please sign in first."),!1):!0}function t(e){var t=['<div class="tips-cont tips-cont-empty">','<div class="tips-box">','<div class="tips-info">','<p class="tips-tit"></p>',"</div>","</div>","</div>"].join(""),n=$(t);n.find(".tips-tit").text(e.text),n.appendTo(e.target)}function n(e){this.config=e,this.config.listItems=this.config.listCont.find(".list ul"),this.config.commentMax=200,this.config.replyMax=200,this.config.hasMoreComment=!0,this.config.page=1}var o={};o.replyForm=['<div class="comment-box reply-box">','<form action="" name="replyForm" id="reply_form">','<textarea class="textarea" name="replyContent" id="reply_content" cols="30" rows="10"></textarea>','<div class="action">','<span class="comment-num"><em class="num">200</em> words</span>','<input type="submit" class="btn-s4" value="Post" />',"</div>","</form>","</div>"].join("");var i=n.prototype;return i.init=function(){var e=this;e.comment(),e.commentDel(),e.reply(),e.moreEvent()},i.comment=function(){var t=this,n=t.config,o=n.commentBox.find("#comment_form"),i=n.commentBox.find(".textarea"),r=n.commentBox.find(".comment-num .num");r.text(n.commentMax),i.keyup(function(){var e=$.trim(i.val()),t=n.commentMax-e.length;r.text(t),0>t?r.addClass("warn-color"):r.removeClass("warn-color")}),o.submit(function(o){if(o.preventDefault(),e()){var a=$.trim(i.val());if(""==a)i.focus();else if(a.length>n.commentMax)alert("Up to "+n.commentMax+" characters can only comment.");else{var m=t.getCurrentTime();console.log("playTime",t.getPlayTime()),$.post("/comment",{play_time:m,user_id:JLib.config.userId,video_id:n.videoId,fragment_id:n.fragmentId,content:a,reply_id:0},function(e){1==e.status?(n.listCont.find(".tips-cont-empty").remove(),$(e.commentHtml).prependTo(n.listItems),i.val(""),r.text(n.commentMax)):alert(e.message)},"json").fail(function(){alert("Sorry! System busy. Please retry later.")})}}})},i.reply=function(){var t=this,n=t.config;n.listCont.on("click",".reply",function(i){function r(){var e=$.trim(d.val()),t=n.replyMax-e.length;p.text(t),0>t?p.addClass("warn-color"):p.removeClass("warn-color")}if(i.preventDefault(),e()){var a=$(this),m=a.parents("li").eq(0),s=m.data("rel"),l=m.find(".item-info");n.replyDom&&n.replyDom.remove(),n.replyDom=$(o.replyForm).appendTo(l);var c=m.find(".user").text(),f=n.replyDom.find("#reply_form"),d=n.replyDom.find(".textarea");d.val("@"+c+" ");var p=n.replyDom.find(".comment-num .num");p.text(n.replyMax);var u=d.val().length;if(d.keyup(function(){r()}).focus(function(){r()}),document.selection){var v=d[0].createTextRange();v.moveEnd("character",-u),v.moveStart("character",u),v.select()}else d[0].setSelectionRange(u,u),d.focus();f.submit(function(e){e.preventDefault();var o=$.trim(d.val());if(""==o)d.focus();else if(o.length>n.replyMax)alert("Up to "+n.replyMax+" characters can only reply.");else{var i=t.getCurrentTime();$.post("/comment",{play_time:i,user_id:JLib.config.userId,video_id:n.videoId,fragment_id:n.fragmentId,content:o,reply_id:s.id},function(e){1==e.status?($(e.commentHtml).prependTo(n.listItems),$(win).scrollTop(n.listCont.offset().top-150),n.replyDom.remove(),n.replyDom=null):alert(e.message)},"json").fail(function(){alert("Sorry! System busy. Please retry later.")})}})}})},i.getCurrentTime=function(){var e=this,t=e.config;return t.player.getCurrentTime()},i.commentDel=function(){var t=this,n=t.config;n.listCont.on("click",".delete",function(t){if(t.preventDefault(),e()){var n=window.confirm("Sure want to delete this comment?");if(n){var o=$(this),i=o.parents("li").eq(0),r=i.data("rel");$.post("/delComment",{reply_id:r.id},function(e){1==e.status?i.remove():alert(e.message)},"json").fail(function(){alert("Sorry! System busy. Please retry later.")})}}})},i.commentMore=function(){var e=this,n=e.config,o=n.listCont.find("#more_comment"),i=o.find(".load"),r=o.find(".loading");n.hasMoreComment&&(r.removeClass("hidden"),i.addClass("hidden"),$.get("/loadComment",{page:n.page,video_id:n.videoId,fragment_id:n.fragmentId},function(e){""==e&&1==n.page?(n.hasMoreComment=!1,o.remove(),t({text:"Comment is empty.",target:n.listCont})):""==e?(n.hasMoreComment=!1,o.remove(),$('<p class="no-more">No more comments.</p>').appendTo(n.listCont)):($(e).appendTo(n.listItems),n.page++,i.removeClass("hidden")),r.addClass("hidden")}).fail(function(){r.addClass("hidden"),i.removeClass("hidden")}))},i.moreEvent=function(){var e=this,t=e.config,n=t.listCont.find("#more_comment .load");n[0]&&n.click(function(t){t.preventDefault(),e.commentMore()})},{isLogin:e,emptyTips:t,commentMod:n}});
//# sourceMappingURL=comment.js.map