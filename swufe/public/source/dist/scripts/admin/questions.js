define(["subtitleselect"],function(e){jQuery(function(t){function i(i){var n,a=i.highlightSchema,r=a.indexOf("id"),d=a.indexOf("st"),c=a.indexOf("et"),s=a.indexOf("title"),l=a.indexOf("brief"),h=a.indexOf("thumbnail"),g=i.highlights,y=[],x=[],O=[],_=0;if(g.length){for(var U=0,R=g.length;R>U;U++){var k=g[U];y.push({thumbnail:k[h],heading:k[s],start:k[d],end:k[c]}),x.push(q.replace(/\{id\}/g,k[r]).replace(/\{heading\}/g,k[s]).replace(/\{start\}/g,k[d]).replace(/\{end\}/g,k[c]).replace(/\{heading\|encoded\}/g,encodeURIComponent(k[s])).replace(/\{description\|encoded\}/g,encodeURIComponent(k[l]))),O.push(w.replace(/\{value\}/g,k[r]).replace(/\{description\}/g,k[s]))}f.html(x.join("")),C.html(O.join("")),I.html(O.join(""))}var b=i.questionSchema,j=b.indexOf("id"),T=b.indexOf("time"),D=b.indexOf("question"),H=b.indexOf("answer"),Q=b.indexOf("choices"),A=b.indexOf("operation"),F=b.indexOf("operationDetail"),B=b.indexOf("gotoHighlightId"),P=i.questions,z=[],J=0;if(P.length)for(var N=0,E=P.length;E>N;N++){var L=P[N];z.push({id:L[j],time:L[T],question:L[D],answer:L[H],choices:L[Q],operation:L[A],operationDetail:L[F],highlightId:L[B]})}for(var W=i.subtitles,$=i.subtitleSchema,G=$.indexOf("token"),K=$.indexOf("st"),V=$.indexOf("et"),X=($.indexOf("score"),0),Y='<li class="line"></li>',Z='<span class="word"></span>',et=[],tt=0,it=W.length;it>tt;tt++){var nt=W[tt].length,at=t(Y);at.attr({id:"line_"+tt}).data({index:tt});for(var ot=null,rt={index:tt,st:W[tt][0][K],et:W[tt][nt-1][V]},dt=0;nt>dt;dt++){var ct=t(Z),st=W[tt][dt],lt=st[G],ht=!1,gt={index:X,st:st[K],et:st[V]};0==dt&&at.attr(rt).data(rt),null==ot||!/^(\w|\d)/.test(lt)||/^(ve|s|ll)$/i.test(lt)&&/^(\'|’)$/.test(ot)||(at.append('<pre class="space'+(n?' word-highlight" data-highlightIndex="'+_+'"':'"')+"> </pre>"),ht=!0),ot=lt,ht&&(lt=" "+lt),ct.attr(t.extend({id:"word_"+X},gt)).data(gt),ct.text(lt),ct.appendTo(at),et.push(ct),X++,y[_]&&gt.st===y[_].start&&(n=!0),n&&(ct.addClass("word-highlight"),ct.data("highlightindex",_)),n&&gt.et===y[_].end&&(n=!1,_++)}at.append(S.replace(/\{time\}/,rt.et)).appendTo(p);var ut=z[J];ut&&rt.st>=ut.time&&(at.before(M.replace(/\{id\}/g,ut.id).replace(/\{stem\|encoded\}/g,encodeURIComponent(ut.question)).replace(/\{stem\}/g,ut.question).replace(/\{time\}/g,ut.time).replace(/\{choices\}/g,encodeURIComponent(t.stringify(ut.choices))).replace(/\{answers\}/g,encodeURIComponent(t.stringify(ut.answer))).replace(/\{action\}/g,ut.operation).replace(/\{actionDetail\}/g,ut.operationDetail).replace(/\{highlightId\}/g,ut.highlightId||"")),J++)}u=e.subtitleSelect({$subtitleList:p,onSelect:function(e){m.data("start",e.start).text(o(e.start)),v.data("end",e.end).text(o(e.end))}})}function n(){var e=t("#addHighlightForm");p.on("click",".addHighlight",function(){e.get(0).reset()}),f.on("click",".removeHighlight",function(){var e=t(this).parents("li"),i=parseInt(e.data("id")),n=e.data("st"),a=e.data("et");return confirm("确定删除这个重点片段？")&&t.ajax({url:"/admin/course/highlightsDestroy",type:"POST",dataType:"json",data:{id:i}}).done(function(o){if(0===o.msgCode){e.remove(),C.children().each(function(){var e=t(this);return parseInt(e.val())===i?(e.remove(),!1):void 0}),I.children().each(function(){var e=t(this);return parseInt(e.val())===i?(e.remove(),!1):void 0});var r;p.find(".word-highlight").each(function(){var e=t(this);return e.data("st")===n&&(r=!0),r&&(e.removeClass("word-highlight"),e.data("et")===a)?!1:void 0}),d("片段删除成功")}else c("片段删除失败")}),!1});var i,n=t("#highlightStartModify"),a=t("#highlightEndModify"),r=t("#modifyHighlightModal"),s=t("#modifyHighlightForm"),l=t("#highlightTitleModify"),h=t("#highlightDescriptionModify");f.on("click",".modifyInfo",function(){var e=t(this).parents("li"),r=parseInt(e.data("id")),d=e.data("st"),c=e.data("et"),g=decodeURIComponent(e.data("heading-encoded")),u=decodeURIComponent(e.data("description-encoded"));s.data("id",r).get(0).reset(),n.data("start",d).text(o(d)),a.data("end",c).text(o(c)),l.val(g),h.val(u),i=e});var g=t("#highlightTitle"),y=t("#highlightDescription");t("#addHighlightButton").click(function(){var e=t.trim(g.val()),i=t.trim(y.val());if(!e)return c("请填写片段标题"),!1;var n={video_guid:O.guid,st:parseFloat(m.data("start")),et:parseFloat(v.data("end")),title:e,description:i};t.ajax({url:"/admin/course/highlightsCreate",type:"POST",data:n}).done(function(t){0===t.msgCode?(x.modal("hide"),f.append(q.replace(/\{id\}/g,t.data.id).replace(/\{heading\}/g,e).replace(/\{start\}/g,n.st).replace(/\{end\}/g,n.et).replace(/\{heading\|encoded\}/g,encodeURIComponent(e)).replace(/\{description\|encoded\}/g,encodeURIComponent(i))),C.append(w.replace(/\{value\}/g,t.data.id).replace(/\{description\}/g,e)),I.append(w.replace(/\{value\}/g,t.data.id).replace(/\{description\}/g,e)),u.turnToMark(),d("添加片段成功")):c("添加片段失败，请稍后再试")})}),t("#modifyHighlightButton").click(function(){var e=t.trim(l.val()),o=t.trim(h.val());if(!e)return c("请填写片段标题"),!1;var g={video_guid:O.guid,highlight_id:s.data("id"),st:parseFloat(n.data("start")),et:parseFloat(a.data("end")),title:e,description:o};t.ajax({url:"/admin/course/highlightsModify",type:"POST",data:g}).done(function(t){0===t.msgCode?(r.modal("hide"),i.replaceWith(q.replace(/\{id\}/g,t.data.id).replace(/\{heading\}/g,e).replace(/\{start\}/g,g.st).replace(/\{end\}/g,g.et).replace(/\{heading\|encoded\}/g,encodeURIComponent(e)).replace(/\{description\|encoded\}/g,encodeURIComponent(o))),d("编辑片段成功")):c("编辑片段失败，请稍后再试")})})}function a(){var e,i=t("#questionTime");p.on("click",".add-quiz",function(){var n=t(this),a=n.data("time");U.get(0).reset(),i.data("time",a).text(o(a)),e=n.parents(".line")}),p.on("click",".delete-quiz",function(){var e=t(this);t.ajax({url:"/admin/course/questionDestroy",method:"POST",data:{question_id:e.data("id")}}).done(function(t){0===t.msgCode?(e.parents(".quiz").remove(),d("删除问题成功")):c("删除问题失败")})});var n,a=t("#modifyQuestionForm"),r=t("#questionTimeModify"),u=t("#questionDescriptionModify"),f=t(".choiceModify"),m=t("#choiceAModify"),v=t("#choiceBModify"),x=t("#choiceCModify"),q=t("#choiceDModify"),w=t(".questionAnswerModify"),S=t(".errorActionModify"),_=t("#questionWarningModify");p.on("click",".edit-quiz",function(){n=t(this).parents(".quiz");var e=n.data();switch(t.isArray(e.choices)||(e.choices=t.parseJSON(decodeURIComponent(e.choices))),a.data("id",e.id).get(0).reset(),r.data("time",e.time).text(o(e.time)),u.val(decodeURIComponent(e.stemEncoded)),t.each(e.choices,function(e,t){f.eq(l(t[0])).val(t[1])}),w.eq(l(t.parseJSON(decodeURIComponent(e.answers))[0])).prop("checked",!0),S.eq(h(A,e.action)).find("a").click(),e.action){case"goto":I.val(e.highlightid);break;case"tips":_.val(e.actiondetail)}});{var U=t("#addQuestionForm"),R=t("#questionDescription"),k=t("#choiceA"),b=t("#choiceB"),j=t("#choiceC"),T=t("#choiceD"),D=t(".questionAnswer"),H=t(".errorAction"),Q=t("#questionWarning"),A=["goto","tips","continue"];t("#closeAddQuestionModal")}t("#addQuestionButton").click(function(){var n=R.val(),a=k.val(),o=b.val(),r=j.val(),d=T.val(),l=D.index(D.filter(":checked")),h=H.index(H.filter(".active")),u=C.val(),p=Q.val();if(!n)return c("请填写题干"),!1;if(!a||!o)return c("请至少填写两个选项"),!1;if(0>l)return c("请选择一个正确答案"),!1;switch(h){case 0:if(!u)return c("请选择片段"),!1;break;case 1:if(!p)return c("请填写提示信息"),!1}var f={};a&&(f[s(0)]=a),o&&(f[s(1)]=o),r&&(f[s(2)]=r),d&&(f[s(3)]=d);var m={video_guid:O.guid,time_point:i.data("time"),title:n,type:"radio",answers:t.stringify(f),correct_answers:t.stringify([s(l)]),error_operation:A[h],target_highlight_id:u,tips_content:p};return t.ajax({url:"/admin/course/questionCreate",type:"POST",data:m}).done(function(i){0===i.msgCode?(y.modal("hide"),U.get(0).reset(),e.after(M.replace(/\{id\}/g,i.data.id).replace(/\{stem\|encoded\}/g,encodeURIComponent(n)).replace(/\{stem\}/g,n).replace(/\{time\}/g,m.time_point).replace(/\{choices\}/g,encodeURIComponent(t.stringify(g(t.parseJSON(m.answers))))).replace(/\{answers\}/g,encodeURIComponent(m.correct_answers)).replace(/\{action\}/g,A[h]).replace(/\{actionDetail\}/g,encodeURIComponent(p)).replace(/\{highlightId\}/g,u||""))):c("创建问题失败")}),!1});var F=t("#modifyQuestionModal");t("#modifyQuestionButton").click(function(){var e=u.val(),i=m.val(),o=v.val(),l=x.val(),h=q.val(),p=w.index(w.filter(":checked")),f=S.index(S.filter(".active")),y=I.val(),C=_.val();if(!e)return c("请填写题干"),!1;if(!i||!o)return c("请至少填写两个选项"),!1;if(0>p)return c("请选择一个正确答案"),!1;switch(f){case 0:if(!y)return c("请选择片段"),!1;break;case 1:if(!C)return c("请填写提示信息"),!1}var M={};i&&(M[s(0)]=i),o&&(M[s(1)]=o),l&&(M[s(2)]=l),h&&(M[s(3)]=h);var U={question_id:a.data("id"),video_guid:O.guid,time_point:r.data("time"),title:e,type:"radio",answers:t.stringify(M),correct_answers:t.stringify([s(p)]),error_operation:A[f],target_highlight_id:y,tips_content:C};return t.ajax({url:"/admin/course/questionModify",type:"POST",data:U}).done(function(i){0===i.msgCode?(F.modal("hide"),a.get(0).reset(),n.data({stemEncoded:encodeURIComponent(e),choices:encodeURIComponent(t.stringify(g(t.parseJSON(U.answers)))),answers:encodeURIComponent(U.correct_answers),action:A[f],actiondetail:encodeURIComponent(C),highlightid:y||""}).find(".questionStem").text(e),d("编辑问题成功")):c("编辑问题失败")}),!1})}function o(e){var t=[];return t[0]=r(Math.floor(e/3600)),t[1]=r(Math.floor(e%3600/60)),t[2]=r(Math.floor(e%60)),t.join(":")}function r(e){var t="0"+(e||0);return t.slice(t.length-2)}function d(e){alert(e)}function c(e){alert(e)}function s(e){return String.fromCharCode(65+e)}function l(e){return e.toUpperCase().charCodeAt()-65}function h(e,i){var n=-1;return t.each(e,function(e,t){return t===i?(n=e,!1):void 0}),n}function g(e){var i=[];return t.each(e,function(e,t){i.push([e,t])}),i}jQuery.extend({stringify:function(e){var t=typeof e;if("object"!=t||null===e)return"string"==t&&(e='"'+e+'"'),String(e);var i,n,a=[],o=e&&e.constructor==Array;for(i in e)n=e[i],t=typeof n,e.hasOwnProperty(i)&&("string"==t?n='"'+n+'"':"object"==t&&null!==n&&(n=jQuery.stringify(n)),a.push((o?"":'"'+i+'":')+String(n)));return(o?"[":"{")+String(a)+(o?"]":"}")}});var u,p=t("#subtitleList").empty(),f=t("#highlightList"),m=t("#highlightStart"),v=t("#highlightEnd"),y=t("#addQuestionModal"),x=t("#addHighlightModal"),C=t("#questionHighlights"),I=t("#questionHighlightsModify"),O=p.data(),q=t.trim(t("#tplHighlightItem").remove().html()),w=t.trim(t("#tplHighlightOption").remove().html()),M=t.trim(t("#tplQuestion").remove().html()),S=t.trim(t("#tplQuestionButton").remove().html());t.getJSON("/admin/getCourseSubtitle?video_guid="+O.guid+"&language="+O.language+"&type=json&version=2",function(e){""==e||void 0==e?console.log("Subtitle load error."):i(e)}).fail(function(){p.html("<li>Failed to load subtitles.</li>")}),n(),a()})});
//# sourceMappingURL=questions.js.map